<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />

    <title>My Home</title>
    <link rel="icon" type="image/ico" href="./images/MyHome.ico" />

    <link rel="stylesheet" href="./external/material-icons.css" />
    <link rel="stylesheet" href="./external/w3.css" />

    <script src="./external/jquery.min.js"></script>
    <!--<script src="./external/vue.min.js"></script>-->
    <!-- TODO: for debug: -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="../external/Chart.bundle.min.js"></script>

    <script src="./components/roomCardComponent.js"></script>
    <script src="./components/sensorsDataComponent.js"></script>
    <script src="./components/camerasComponent.js"></script>
    <script src="./components/mediaPlayerComponent.js"></script>
    <script src="./components/securityListComponent.js"></script>

    <link rel="stylesheet" href="./style.css" />
    <script src="./scripts.js"></script>

    <script>
        $(window).on("load", function () {
            window.vue = new Vue({
                el: "#vue-content",
                data: {
                    rooms: [],
                    mediaPlayer: {},
                    ui: {
                        mediaPlayerHover: false
                    }
                },
                methods: {
                    allRoomsSecuritySystemEnabled: function () {
                        return this.rooms.length > 0 && this.rooms.filter(r => 'Motion' in r.SensorsValues).every(r => r.IsSecuritySystemEnabled)
                    },
                    someRoomSecuritySystemEnabled: function () {
                        let roomsWithSecurity = this.rooms.filter(r => 'Motion' in r.SensorsValues);
                        return roomsWithSecurity.some(r => r.IsSecuritySystemEnabled) && !roomsWithSecurity.every(r => r.IsSecuritySystemEnabled)
                    },

                    mediaPlayerHover: function () {
                        if (!this.ui.mediaPlayerHover) {
                            this.ui.mediaPlayerHover = true;
                            getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
                        }
                    }
                }
            });

            function update() {
                getRooms().done(rooms => {
                    updateVue({ rooms: rooms });
                    setTimeout(update, 3000);
                }).fail((response) => {
                    if (response.status == 401) // unauthorized
                        window.location.replace("/login.html");
                    else
                        setTimeout(update, 1000)
                });

                // update media player if is opened
                if (window.vue.ui.mediaPlayerHover) {
                    getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
                }
            }

            update();
        });
    </script>
</head>
<body>
    <div id="vue-content">
        <!-- Title bar -->
        <div class="w3-bar w3-padding w3-display-container title-bar">
            <div class="w3-display-middle w3-cell">
                <img src="./images/MyHome.ico" width="32" class="w3-cell-middle" />
                <h3 class="w3-cell-middle w3-padding-small w3-show-inline-block">My Home</h3>
            </div>
            <div class="w3-display-right w3-padding w3-padding-top-24">
                <a href="/"><span class="material-icons">home</span></a>
                <a href="#"><span class="material-icons w3-text-gray w3-hover-text-white">add_circle_outline</span></a>
                <a href="./settings.html"><span class="material-icons w3-text-gray w3-hover-text-white">settings</span></a>
            </div>
        </div>

        <!-- Content -->
        <div class="w3-content w3-padding-16">
            <!-- Rooms info -->
            <div class="w3-col m3 w3-margin" v-for="room of rooms">
                <room-card v-bind:room="room"></room-card>
            </div>
        </div>

        <!-- Bottom bar -->
        <div class="w3-padding-large w3-bottom w3-margin-bottom w3-right-align">
            <!-- Media Player -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8"
                 @mouseover="mediaPlayerHover()" @mouseleave="ui.mediaPlayerHover = false">
                <span class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                      v-bind:class="{'w3-text-light-green': mediaPlayer.Playing}">
                    video_library
                </span>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <media-player v-bind:media-player="mediaPlayer"></media-player>
                </div>
            </div>

            <!-- Security -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8">
                <span class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                      v-bind:class="{'w3-text-lime': someRoomSecuritySystemEnabled(), 'w3-text-green': allRoomsSecuritySystemEnabled()}">
                    security
                </span>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <security-list v-bind:rooms="rooms"></security-list>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
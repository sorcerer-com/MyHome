<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />

    <title>My Home</title>
    <link rel="icon" type="image/ico" href="./images/MyHome.ico" />

    <link rel="stylesheet" href="./external/material-icons.css" />
    <link rel="stylesheet" href="./external/w3.css" />

    <script src="./external/jquery.min.js"></script>
    <!--<script src="./external/vue.min.js"></script>-->
    <!-- TODO: for debug: -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>
    <script src="./external/Chart.bundle.min.js"></script>

    <script src="./components/roomCardComponent.js"></script>
    <script src="./components/sensorsDataComponent.js"></script>
    <script src="./components/camerasComponent.js"></script>

    <script src="./components/mediaPlayerComponent.js"></script>
    <script src="./components/securityListComponent.js"></script>

    <script src="./components/createObjectComponent.js"></script>

    <link rel="stylesheet" href="./style.css" />
    <script src="./scripts.js"></script>

    <script>
        $(window).on("load", function () {
            window.vue = new Vue({
                el: "#vue-content",
                data: {
                    rooms: [],
                    mediaPlayer: {},
                    logs: [],
                    upgradeAvailable: false,
                    ui: {
                        mediaPlayerHover: false,
                        modal: "",
                        addObject: null
                    }
                },
                methods: {
                    addRoom: function (room) {
                        if (this.rooms.some(r => r.Name == room.Name)) // room exists
                            return $.Deferred().reject({ responseText: "A room with the same name already exists" });
                        return setRoom(room.Name, room).done(() => this.ui.modal = "");
                    },
                    upgrade: function () {
                        upgrade().done(() => {
                            $("#vue-content").html("Upgrade was successfull! Rebooting...");
                            setTimeout(() => window.location.reload(true), 30000);
                        });
                    },

                    allRoomsSecuritySystemEnabled: function () {
                        return this.rooms.length > 0 && this.rooms.filter(r => 'Motion' in r.SensorsValues).every(r => r.IsSecuritySystemEnabled)
                    },
                    someRoomSecuritySystemEnabled: function () {
                        let roomsWithSecurity = this.rooms.filter(r => 'Motion' in r.SensorsValues);
                        return roomsWithSecurity.some(r => r.IsSecuritySystemEnabled) && !roomsWithSecurity.every(r => r.IsSecuritySystemEnabled)
                    },

                    showAddRoomModal: function () {
                        this.ui.modal = "Add Room";
                        getType("Room").done(room => this.ui.addObject = fixDateTimes(room));
                    },
                    showLogsModal: function () {
                        this.ui.modal = "Logs";
                        getLogs().done(logs => this.logs = logs.reverse());
                    },
                    mediaPlayerHover: function () {
                        if (!this.ui.mediaPlayerHover) {
                            this.ui.mediaPlayerHover = true;
                            getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
                        }
                    }
                }
            });

            function update() {
                getRooms().done(rooms => {
                    updateVue({ rooms: rooms });
                    setTimeout(update, 3000);
                }).fail(response => {
                    if (response.status == 401) // unauthorized
                        window.location.replace("./login.html");
                    else
                        setTimeout(update, 1000)
                });

                getUpgradeAvailable().done(value => updateVue({ upgradeAvailable: value }));

                // update logs if the modal is opened
                if (window.vue.ui.modal == "Logs") {
                    getLogs().done(logs => updateVue({ logs: logs.reverse() }));
                }

                // update media player if it is opened
                if (window.vue.ui.mediaPlayerHover) {
                    getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
                }
            }

            update(true);
            getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
        });
    </script>
</head>
<body>
    <!-- TODO: tooltips -->
    <div id="vue-content">
        <!-- Title bar -->
        <div class="w3-bar">
            <div class="w3-center display-center">
                <img src="./images/MyHome.ico" width="32" class="w3-cell-middle" />
                <h3 class="w3-cell-middle w3-padding-small w3-show-inline-block">My Home</h3>
            </div>
            <div class="w3-right w3-padding w3-padding-top-24">
                <a href="./" class="material-icons">home</a>
                <div class="w3-dropdown-hover">
                    <a class="w3-text-gray w3-hover-text-white material-icons">add_circle_outline</a>
                    <div class="w3-dropdown-content w3-padding-small w3-round-large w3-animate-opacity dropdown-right bg-gray">
                        <a v-on:click="showAddRoomModal()" class="w3-show-block w3-hover-text-white padding-4">Add Room</a>
                        <a class="w3-show-block w3-hover-text-white padding-4">Add Device</a>
                    </div>
                </div>
                <a class="material-icons w3-text-gray w3-hover-text-white">settings</a>
                <a v-on:click="showLogsModal()" class="material-icons w3-text-gray w3-hover-text-white">assignment</a>
                <!-- Upgrade -->
                <a class="w3-show-block w3-tiny w3-cell-middle margin-right-8"
                   v-if="upgradeAvailable != false"
                   v-on:click="upgrade">
                    <span v-if="upgradeAvailable">
                        <span class="w3-cell-middle material-icons font-size-normal">assignment_late</span>
                        Upgrade Available
                    </span>
                    <span v-if="upgradeAvailable == null">
                        <span class="w3-cell-middle material-icons font-size-normal">error</span>
                        Upgrade failed
                    </span>
                </a>
            </div>
        </div>

        <!-- Content -->
        <div id="scrollable-content">
            <div class="w3-content w3-padding-16">
                <!-- Rooms info -->
                <div class="w3-col m3 w3-margin" v-for="room of rooms">
                    <room-card v-bind:room="room"></room-card>
                </div>
            </div>
        </div>

        <!-- Bottom bar -->
        <div class="w3-padding-large w3-bottom w3-margin-bottom w3-right-align">
            <!-- Media Player -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8"
                 @mouseover="mediaPlayerHover()" @mouseleave="ui.mediaPlayerHover = false">
                <a class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                   v-bind:class="{'w3-text-light-green': mediaPlayer.Playing}">
                    video_library
                </a>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <media-player v-bind:media-player="mediaPlayer"></media-player>
                </div>
            </div>

            <!-- Security -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8">
                <a class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                   v-bind:class="{'w3-text-lime': someRoomSecuritySystemEnabled(), 'w3-text-green': allRoomsSecuritySystemEnabled()}">
                    security
                </a>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <security-list v-bind:rooms="rooms"></security-list>
                </div>
            </div>
        </div>

        <!-- Modal -->
        <div class="w3-modal" v-if="ui.modal"
             v-bind:class="{'w3-show-block': ui.modal}"
             v-on:click="ui.modal = ''">
            <div class="w3-modal-content w3-card-4 w3-transparent" v-on:click.stop="">
                <header class="w3-container w3-blue-gray">
                    <span class="w3-button w3-display-topright" v-on:click="ui.modal = ''">&times;</span>
                    <h2>{{ui.modal}}</h2>
                </header>
                <div class="w3-container w3-padding-16 height-100 overflow-y-auto bg-gray">
                    <ul class="w3-ul w3-monospace" v-if="ui.modal == 'Logs'">
                        <li v-for="log of logs" class="w3-hover-opacity overflow-wrap-break-word"
                            v-bind:class="{'w3-red': log.includes('ERROR'), 'w3-purple': log.includes('WARN')}">
                            {{log}}
                        </li>
                    </ul>
                    <create-object v-if="ui.modal == 'Add Room'" v-bind:object="ui.addObject" v-bind:onsave="addRoom"></create-object>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, width=device-width" />

    <title>My Home</title>
    <link rel="icon" type="image/ico" href="./images/MyHome.ico" />

    <link rel="stylesheet" href="./external/material-icons.css" />
    <link rel="stylesheet" href="./external/w3.css" />

    <script src="./external/jquery.min.js"></script>
    <!--<script src="./external/vue.min.js"></script>-->
    <!-- TODO: for debug: -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.12/dist/vue.js"></script>

    <script src="./components/roomCardComponent.js"></script>

    <link rel="stylesheet" href="./style.css" />
    <script src="./scripts.js"></script>

    <script>
        $(() => {
            window.vue = new Vue({
                el: "#vue-content",
                data: {
                    rooms: [],
                    mediaPlayer: {},
                    ui: {
                        mediaPlayerHover: false,
                        selectedMediaItem: ""
                    }
                },
                methods: {
                    someRoomSecuritySystemEnabled: function () {
                        return this.rooms.some(r => r.IsSecuritySystemEnabled) && !this.rooms.every(r => r.IsSecuritySystemEnabled)
                    },
                    setRoomSecuritySystemEnabled: function (roomName, isEnabled) {
                        setRoom(roomName, { IsSecuritySystemEnabled: isEnabled })
                            .done(() => getRooms().done(rooms => updateVue({ rooms: rooms })));
                    },
                    setAllRoomsSecuritySystemEnabled: function (isEnabled) {
                        for (let room of this.rooms)
                            this.setRoomSecuritySystemEnabled(room.Name, isEnabled);
                    },


                    mediaPlayerHover: function () {
                        if (!this.ui.mediaPlayerHover) {
                            this.ui.mediaPlayerHover = true;
                            getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer }));
                        }
                    },
                    getMediaList: function () {
                        if (Object.keys(this.mediaPlayer).length == 0)
                            return {};
                        return this.mediaPlayer.MediaList.reduce((pv, x) => {
                            let key = x.substr(0, x.indexOf(":"));
                            let watched = this.mediaPlayer.Watched.includes(x);
                            (pv[key] = pv[key] || []).push({
                                name: x.substr(x.lastIndexOf("\\") + 1),
                                path: x.substr(x.indexOf(":") + 1),
                                watched: watched
                            });
                            return pv;
                        }, {});
                    },
                    selectMediaItem: function (event) {
                        this.ui.selectedMediaItem = event.target.title;
                        $(event.target).parent().parent().find("a").removeClass("w3-blue-gray"); // unselect all
                        $(event.target).addClass("w3-blue-gray");
                    },
                    callMediaPlayer: function (funcName, ...args) {
                        callSystem("MediaPlayer", funcName, ...args)
                            .done(getSystem("MediaPlayer").done(mediaPlayer => updateVue({ mediaPlayer: mediaPlayer })));
                    }
                }
            });

            function update() {
                getRooms().done(rooms => {
                    updateVue({ rooms: rooms });
                    setTimeout(update, 3000);
                }).fail(() => setTimeout(update, 1000));
            }

            update();
        });
    </script>
</head>
<body>
    <div id="vue-content">
        <!-- Title bar -->
        <div class="w3-bar w3-padding w3-display-container title-bar">
            <div class="w3-display-middle w3-cell">
                <img src="./images/MyHome.ico" width="32" class="w3-cell-middle" />
                <h3 class="w3-cell-middle w3-padding-small w3-show-inline-block">My Home</h3>
            </div>
            <div class="w3-display-right w3-padding w3-padding-top-24">
                <a href="/"><span class="material-icons">home</span></a>
                <a href="#"><span class="material-icons w3-text-gray w3-hover-text-white">add_circle_outline</span></a>
                <a href="./settings.html"><span class="material-icons w3-text-gray w3-hover-text-white">settings</span></a>
            </div>
        </div>

        <!-- Content -->
        <div class="w3-content w3-padding-16">
            <!-- Rooms info -->
            <div class="w3-col m3 w3-margin" v-for="room of rooms">
                <room-card v-bind:room="room"></room-card>
            </div>
        </div>

        <!-- Bottom bar -->
        <div class="w3-padding-large w3-bottom w3-margin-bottom w3-right-align">
            <!-- Media Player -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8"
                 @mouseover="mediaPlayerHover()" @mouseleave="ui.mediaPlayerHover = false">
                <span class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                      v-bind:class="{'w3-text-light-green': mediaPlayer.Playing}">
                    video_library
                </span>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <!-- TODO: move to components (system too?)-->
                    <div class="w3-padding-small w3-round-large w3-animate-opacity margin-8 bg-gray-opacity-4"
                         style="width: 300px">
                        <!-- media list -->
                        <div class="w3-small w3-left-align w3-text-white margin-8 overflow-y-auto"
                             style="max-height:300px;"
                             v-if="!mediaPlayer.Playing">
                            <div class="margin-right-8 margin-bottom-8" v-for="(items, media) of getMediaList()">
                                <h4 class="reset-margin">{{media}}</h4>
                                <hr class="reset-margin margin-bottom-8" />
                                <a class="w3-show-block w3-hover-blue-gray padding-4"
                                   v-for="item of items" v-bind:title="media + ':' + item.path"
                                   v-bind:class="{'w3-text-dark-gray': item.watched}"
                                   v-on:click="selectMediaItem">
                                    {{item.name}}
                                </a>
                            </div>
                        </div>
                        <!-- playing -->
                        <div class="w3-center w3-text-white margin-8"
                             v-if="mediaPlayer.Playing">
                            {{mediaPlayer.Playing.substr(mediaPlayer.Playing.lastIndexOf("\\") + 1)}}
                        </div>
                        <!-- buttons -->
                        <div class="w3-text-black margin-right-8">
                            <span class="w3-small w3-left" v-if="mediaPlayer.Playing">{{mediaPlayer.TimeDetails}}</span>
                            <a class="w3-small w3-cell-middle material-icons"
                               v-bind:class="{'w3-hover-text-white': mediaPlayer.Playing, 'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('VolumeUp')">
                                volume_up
                            </a>
                            <span class="w3-small">/</span>
                            <a class="w3-small w3-hover-text-white w3-cell-middle material-icons"
                               v-bind:class="{'w3-hover-text-white': mediaPlayer.Playing, 'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('VolumeDown')">
                                volume_down
                            </a>
                        </div>
                        <div class="w3-center margin-bottom-8">
                            <a class="w3-button w3-padding-small w3-round-large w3-grey w3-hover-light-grey font-size-normal material-icons"
                               v-bind:class="{'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('SeekBackFast')">
                                fast_rewind
                            </a>
                            <a class="w3-button w3-padding-small w3-round-large w3-grey w3-hover-light-grey font-size-normal material-icons"
                               v-bind:class="{'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('SeekBack')">
                                keyboard_arrow_left
                            </a>
                            <a class="w3-button w3-xlarge w3-padding-small w3-white w3-hover-gray w3-round-xxlarge padding-4 material-icons"
                               v-bind:class="{'disabled': !ui.selectedMediaItem}"
                               v-show="!mediaPlayer.Playing || mediaPlayer.Paused"
                               v-on:click="mediaPlayer.Paused ? callMediaPlayer('Pause') : callMediaPlayer('Play', ui.selectedMediaItem)">
                                play_arrow
                            </a>
                            <a class="w3-button w3-xlarge w3-padding-small w3-white w3-hover-gray w3-round-xxlarge padding-4 material-icons"
                               v-show="mediaPlayer.Playing && !mediaPlayer.Paused"
                               v-on:click="callMediaPlayer('Pause')">
                                pause
                            </a>
                            <a class="w3-button w3-xlarge w3-padding-small w3-white w3-hover-gray w3-round-xxlarge padding-4 material-icons"
                               v-show="mediaPlayer.Playing"
                               v-on:click="callMediaPlayer('Stop')">
                                stop
                            </a>
                            <a class="w3-button w3-padding-small w3-round-large w3-grey w3-hover-light-grey font-size-normal material-icons"
                               v-bind:class="{'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('SeekForward')">
                                keyboard_arrow_right
                            </a>
                            <a class="w3-button w3-padding-small w3-round-large w3-grey w3-hover-light-grey font-size-normal material-icons"
                               v-bind:class="{'disabled': !mediaPlayer.Playing}"
                               v-on:click="callMediaPlayer('SeekForwardFast')">
                                fast_forward
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Security -->
            <div class="w3-dropdown-hover w3-transparent margin-left-8">
                <span class="w3-button w3-round-xxlarge w3-white w3-hover-blue-grey padding-4 material-icons"
                      v-bind:class="{'w3-text-lime': someRoomSecuritySystemEnabled(), 'w3-text-green': rooms.every(r => r.IsSecuritySystemEnabled)}">
                    security
                </span>
                <div class="w3-dropdown-content w3-transparent dropdown-top-right">
                    <div class="w3-padding-small w3-round-large w3-animate-opacity margin-8 bg-gray-opacity-4">
                        <!-- rooms statuses -->
                        <div class="w3-left-align" v-for="room of rooms">
                            <a v-on:click="setRoomSecuritySystemEnabled(room.Name, !room.IsSecuritySystemEnabled);">
                                <span class="w3-cell-middle w3-small material-icons">
                                    <span v-show="room.IsSecuritySystemEnabled" class="w3-text-light-green">check_circle</span>
                                    <span v-show="!room.IsSecuritySystemEnabled" class="w3-text-red">cancel</span>
                                </span>
                                <span class="w3-cell-middle">{{room.Name}}</span>
                            </a>
                            <span class="w3-cell-middle w3-large w3-text-red w3-animate-fading margin-left-8 material-icons"
                                  v-show="room.IsSecuritySystemActivated">
                                warning
                            </span>
                        </div>
                        <!-- enable/disable all -->
                        <div class="w3-tiny w3-right-align">
                            <a class="w3-hover-text-light-green"
                               v-show="rooms.some(r => !r.IsSecuritySystemEnabled)"
                               v-on:click="setAllRoomsSecuritySystemEnabled(true);">
                                Enable All
                            </a>
                            <a class="w3-hover-text-light-green"
                               v-show="rooms.every(r => r.IsSecuritySystemEnabled)"
                               v-on:click="setAllRoomsSecuritySystemEnabled(false);">
                                Disable All
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>